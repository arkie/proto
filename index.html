<?doctype html>
<html>
	<head>
		<title>dungeon</title>
		<style type="text/css">
			* {margin:0; padding:0;}
		</style>
		<script type="text/javascript">
			var collides = function(bounds1, bounds2){
				return (bounds1.left < bounds2.right &&
						bounds1.right > bounds2.left &&
						bounds1.top < bounds2.bottom &&
						bounds1.bottom > bounds2.top)
			}
			var rect = function(){
				this.width = this.height = 20;
				this.bounds = function(x, y){
					if (x == null) x = this.x;
					if (y == null) y = this.y;
					var w = this.width/2, h = this.height/2;
					return {left:x-w, right:x+w, top:y-h, bottom:y+h}
				}
				this.draw = function(ctx){
					ctx.fillStyle = this.color;
					ctx.fillRect(this.x-this.height/2, this.y-this.width/2,
							this.height, this.width);
				}
			}
			var types = {}
			types.dude = function(){
				rect.call(this);
				this.x = this.y = 0;
				this.color = '00f';
				this.speed = 5;
				this.test = function(x, y){
					for (var t in this.things){
						t = this.things[t];
						if (t != this){
							if (collides(this.bounds(x, y), t.bounds()))
								return true;
						}
					}
					return null;
				}
				this.move = function(dx, dy){
					if (!this.test(this.x+dx, this.y+dy)){
						this.x += dx;
						this.y += dy;
					}
				}
				this.update = function(){
					var speed = this.speed;
					//if ((this.left||this.right)&&(this.up||this.down))
						//speed *= .7;
					if (this.left) this.move(-speed, 0);
					if (this.right) this.move(+speed, 0);
					if (this.up) this.move(0, -speed);
					if (this.down) this.move(0, +speed);
				}
			}
			types.mob = function(){
				rect.call(this);
				this.x = this.y = 500;
				this.color = 'f00';
			}
			types.wall = function(x, y){
				rect.call(this);
				this.width = this.height = 20;
				this.x = x; this.y = y;
				this.color = '000';
			}

			window.onload = function(){
				var cvs = document.getElementById('canvas');
				var ctx = cvs.getContext('2d');
				var draw = function(ctx, things){
					ctx.clearRect(0, 0, cvs.width, cvs.height);
					ctx.save();
					ctx.translate(cvs.width/2, cvs.height/2);
					for (var t in things) things[t].draw(ctx);
					ctx.restore();
				};
				var things = [];
				for (var x = -2; x <= 2; x++)
					for (var y = -2; y <= 2; y++)
						if (x || y) things.push(new types.wall(x*40, y*40));
				dude = new types.dude();
				dude.things = things;
				things.push(dude);

				setInterval(function(){
					for (var t in things)
						if (things[t].update) things[t].update();
					draw(ctx, things);
				}, 20);

				(window.onresize = function(){
					cvs.width  = window.innerWidth;
					cvs.height = window.innerHeight;
					draw(ctx, things);
				})();
				var keys = {37:'left', 38:'up', 39:'right', 40:'down'}
				window.onkeydown = window.onkeyup = function(e){
					var k = keys[e.keyCode];
					if (k) dude[k] = e.type == 'keydown';
				}
			}
		</script>
	</head>
	<body>
		<canvas id="canvas"></canvas>
	</body>
</html>
