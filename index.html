<?doctype html>
<html>
	<head>
		<title>dungeon</title>
		<style type="text/css">
			* {margin:0; padding:0;}
		</style>
		<script type="text/javascript">
			var collides = function(bounds1, bounds2){
				return (bounds1.left < bounds2.right &&
						bounds1.right > bounds2.left &&
						bounds1.top < bounds2.bottom &&
						bounds1.bottom > bounds2.top)
			}
			var move = function(self, dx, dy){
				for (var t in things){
					t = things[t];
					if (t != self)
						if (collides(self.bounds(self.x+dx,
								self.y+dy), t.bounds())) return false;
				}
				self.x += dx;
				self.y += dy;
			}
			var rect = function(){
				this.width = this.height = 20;
				this.bounds = function(x, y){
					if (x == null) x = this.x;
					if (y == null) y = this.y;
					var w = this.width/2, h = this.height/2;
					return {left:x-w, right:x+w, top:y-h, bottom:y+h}
				}
				this.draw = function(ctx){
					ctx.fillStyle = this.color;
					ctx.fillRect(this.x-this.height/2, this.y-this.width/2,
							this.height, this.width);
				}
			}
			var types = {}
			types.dude = function(){
				rect.call(this);
				this.x = this.y = 0;
				this.color = 'blue';
				this.speed = 5;
				this.update = function(){
					if (this.left)  move(this, -this.speed, 0);
					if (this.right) move(this, +this.speed, 0);
					if (this.up)    move(this, 0, -this.speed);
					if (this.down)  move(this, 0, +this.speed);
				}
			}
			types.mob = function(x, y){
				rect.call(this);
				this.x = x; this.y = y;
				this.color = 'red';
				this.speed = 2.5;
				this.update = function(){
					if (this.x > dude.x) move(this, -this.speed, 0);
					if (this.x < dude.x) move(this, +this.speed, 0);
					if (this.y > dude.y) move(this, 0, -this.speed);
					if (this.y < dude.y) move(this, 0, +this.speed);
				}
			}
			types.wall = function(x, y){
				rect.call(this);
				this.width = this.height = 20;
				this.x = x; this.y = y;
				this.color = 'black';
			}
			var things = [];
			var dude = new types.dude();
			things.push(dude);
			for (var x = -4; x <= 4; x++)
				things.push(new types.mob(x*40, 200));

			window.onload = function(){
				var cvs = document.getElementById('canvas');
				var ctx = cvs.getContext('2d');
				var draw = function(ctx, things){
					ctx.clearRect(0, 0, cvs.width, cvs.height);
					ctx.save();
					ctx.translate(cvs.width/2, cvs.height/2);
					for (var t in things) things[t].draw(ctx);
					ctx.restore();
				};
				for (var x = -4; x <= 4; x++)
					for (var y = -4; y <= 4; y++)
						if (x || y){
							things.push(new types.wall(x*40, y*40));
							if (Math.random() > .8)
								things.push(new types.wall(x*40+20, y*40));
							if (Math.random() < .2)
								things.push(new types.wall(x*40, y*40+20));
						}

				setInterval(function(){
					for (var t in things)
						if (things[t].update) things[t].update();
					draw(ctx, things);
				}, 20);

				(window.onresize = function(){
					cvs.width  = window.innerWidth;
					cvs.height = window.innerHeight;
					draw(ctx, things);
				})();
				var keys = {37:'left', 38:'up', 39:'right', 40:'down'}
				window.onkeydown = window.onkeyup = function(e){
					var k = keys[e.keyCode];
					if (k) dude[k] = e.type == 'keydown';
				}
			}
		</script>
	</head>
	<body>
		<canvas id="canvas"></canvas>
	</body>
</html>
